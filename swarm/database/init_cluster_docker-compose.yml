version: '3.9'

services:
  node1:
    hostname: node1_init
    image: percona/percona-xtradb-cluster:8.0
    networks:
      - cluster_network
    environment:
      - TZ=Europe/Kiev
      - CLUSTER_NAME=MikbillCluster
      - MYSQL_ROOT_PASSWORD=mikbill
      - MYSQL_ROOT_HOST=mysql_balancer
      - MYSQL_USER=mikbill
      - MYSQL_PASSWORD=mikbill
      - MYSQL_DATABASE=mikbill
    volumes:
      - ./scripts/init.sh:/init.sh
      - ./certs:/certs
      - cluster_node1:/var/lib/mysql
    entrypoint: ["/init.sh"]
    command: --default-time-zone='Europe/Kiev'
    configs:
      - source: cluster_config
        target: /etc/node.cnf
        uid: '1'
        gid: '1'
        mode: 0664
    restart: unless-stopped
    deploy:
      placement:
        constraints:
          - node.hostname==mb-database

configs:
  cluster_config:
    file: ./conf/init_cluster.cnf

volumes:
  cluster_node1:
    driver_opts:
      type: none
      o: bind
      device: /mnt/mysql-data/node1

networks:
  cluster_network:
    external: true
    name: cluster_network